# ============================================================
# Server Agent 영속 상태 — 세션 간 컨텍스트 유지용
# agent_loop.py가 Claude 실행 시 이 파일을 강제 주입
# 매 작업 완료 후 Claude가 이 파일을 업데이트
# ============================================================

agent: server
project_root: "C:\\Users\\gnidev0095\\OneDrive\\바탕 화면\\Lost\\GameServerSkeleton"
last_session: "2026-02-15T10:10:00"

# ── 현재 상태 ──
current_status: "Phase 3 진행 중. C021 처리 완료 — _patch_s040.py로 5가지 포맷 불일치 해결(INSTANCE_CREATE 핸들러+듀얼 포맷). S040 응답 발송. 46/46 PASS 유지. 클라 25/25 테스트 결과 대기."

# ── 완료된 작업 ──
completed:
  - id: S001-S010
    desc: "초기 통신 체계 구축, protocol.yaml, Phase 0/1 협의"
    files: ["_comms/server_to_client/S001~S010"]
  - id: S011-S015
    desc: "야근 #1~5: 채팅/장비스탯/상점/스킬확장/보스메카닉"
    files: ["ChatComponents.h", "ShopComponents.h", "SkillComponents.h", "BossComponents.h"]
  - id: S016-S018
    desc: "이동검증 Model C, 몬스터 AI 6상태FSM, 데이터드리븐+핫리로드"
    files: ["MonsterAISystem.h", "GameConfig.h", "ConfigLoader.h"]
  - id: S019
    desc: "서버 현황 총정리 + 신규 패킷 23개 한방 정리"
    files: ["_comms/server_to_client/S019*"]
  - id: S020
    desc: "TCP 브릿지 서버 v1.0 구현 (asyncio, 포트 7777, 20 PASS)"
    files: ["Servers/BridgeServer/tcp_bridge.py", "test_tcp_bridge.py"]
  - id: S021-S028
    desc: "포맷 불일치 수정, enum 버그 6건 수정, 비주얼 프로토타입 에셋 안내"
    files: ["tcp_bridge.py", "test_tcp_bridge.py"]
  - id: S029
    desc: "문파/거래/우편 3대 시스템 구현 (Session 38-40, MsgType 290-318)"
    files: ["tcp_bridge.py"]
  - id: S030
    desc: "GDD 시스템 21파일 9000줄 완성"
    files: ["_gdd/rules/*.yaml", "_gdd/game_design.yaml"]
  - id: S031
    desc: "C016 응답: CEO 카메라 결정(쿼터뷰)+GDD 크로스파일 8건 수정+엔티티 파이프라인 보류"
    files: ["_gdd/rules/combat.yaml", "_gdd/rules/ui.yaml", "_gdd/rules/items.yaml", "_gdd/rules/ai_behavior.yaml", "_gdd/rules/flow.yaml", "_comms/conversation_journal.json"]
  - id: S032
    desc: "GDD 데이터 DB 5개 CSV 생성 — monsters(20종)/skills(30개)/items(50+)/quests(25개)/npcs(18명)"
    files: ["_gdd/data/monsters.csv", "_gdd/data/skills.csv", "_gdd/data/items.csv", "_gdd/data/quests.csv", "_gdd/data/npcs.csv"]
  - id: S033
    desc: "P1 패킷 3종: SERVER_LIST(320-321)/CHARACTER_CRUD(322-327)/TUTORIAL(330-331). 23/23 PASS."
    files: ["Servers/BridgeServer/tcp_bridge.py", "Servers/BridgeServer/test_tcp_bridge.py", "Servers/BridgeServer/_patch.py"]
  - id: S034
    desc: "GDD 서버 태스크 4건: 튜토리얼 몬스터(P1_S02_S01)/NPC 대화(P1_S04_S01,332-333)/마을 NPC(P1_S05_S01)/강화(P2_S02_S01,340-341). 28/28 PASS."
    files: ["Servers/BridgeServer/tcp_bridge.py", "Servers/BridgeServer/test_tcp_bridge.py", "Servers/BridgeServer/_patch_s034.py"]
  - id: S035
    desc: "GDD 서버 태스크 2건: 필드 몬스터 확장(P2_S01_S01, zone1-3 총 30마리)+던전 매칭(P2_S03_S01, MATCH/INSTANCE 핸들러 6개+던전 4종). 34/34 PASS."
    files: ["Servers/BridgeServer/tcp_bridge.py", "Servers/BridgeServer/test_tcp_bridge.py", "Servers/BridgeServer/_patch_s035.py"]
  - id: S036
    desc: "GDD P3 서버 태스크 2건: PvP 아레나(P3_S01_S01, 1v1/3v3 매칭+스탯정규화+ELO+승패판정, MsgType 350-359)+레이드 보스 기믹(P3_S02_S01, 3페이즈+기믹6종+enrage+클리어보상, MsgType 370-379). 46/46 PASS."
    files: ["Servers/BridgeServer/tcp_bridge.py", "Servers/BridgeServer/test_tcp_bridge.py", "Servers/BridgeServer/_patch_s036.py"]
  - id: S037
    desc: "인벤토리 테스트 #10 리그레션 수정 — TestClient.recv_expect() 추가로 몬스터 스폰 패킷 간섭 해결. 46/46 PASS."
    files: ["Servers/BridgeServer/_patch_s037.py"]
  - id: S035_msg
    desc: "C019 응답: S033/S034 연동 확인 + Phase 2 TCP 브릿지 테스트 가이드 전달."
    files: ["_comms/server_to_client/S035_c019_response_phase2_ready.md"]
  - id: S038
    desc: "C020 응답: Phase 2 TCP 실연동 14/14 ALL PASS. test_phase2_tcp.py 11-step 전체 통과. Phase 2 공식 완료."
    files: ["_comms/server_to_client/S038_c020_response_phase2_tcp_test_passed.md"]
  - id: S040
    desc: "C021 응답: Phase 3 브릿지 호환성 패치. INSTANCE_CREATE(170) 핸들러 추가, MATCH_ENQUEUE/DEQUEUE/INSTANCE_LEAVE 듀얼 포맷, MATCH_STATUS 응답 호환. 46/46 PASS."
    files: ["Servers/BridgeServer/_patch_s040.py", "_comms/server_to_client/S040_c021_response_phase3_bridge_compat.md"]

# ── 대기 중 (클라이언트 응답 필요) ──
blocked:
  - reason: "Phase 3 연동 테스트 — 클라 25/25 ALL PASS 확인 대기"
    waiting_for: "클라이언트 test_tcp_bridge_client.py 25/25 결과"

# ── 다음 할 일 ──
pending_tasks:

  # ============================================================
  # TASK 1: C021 응답 — COMPLETE (_patch_s040.py로 해결)
  # INSTANCE_CREATE 핸들러 추가 + 듀얼 포맷 5건 수정.
  # 46/46 PASS 유지. S040 메시지 발송 완료.
  # ============================================================

  # ============================================================
  # TASK 2: 제작/채집/요리/인챈트 시스템 (GDD rules/crafting.yaml)
  # GDD에 상세 정의됨, tcp_bridge에 미구현.
  # ============================================================
  - id: "crafting_sub01"
    desc: "CRAFT_LIST_REQ(380)→CRAFT_LIST(381) 핸들러 — 제작 레시피 목록 반환. proficiency_level 기반 필터. crafting.yaml recipes 데이터 로드."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "crafting_sub02"
    desc: "CRAFT_EXECUTE(382)→CRAFT_RESULT(383) 핸들러 — 재료 검증 + 골드 차감 + success_rate 확률 판정 + 결과 아이템 생성 + bonus_option_chance 처리."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "crafting_sub03"
    desc: "GATHER_START(384)→GATHER_RESULT(385) 핸들러 — 채집 시작(에너지 차감) + gather_time 후 결과(loot table 확률 드롭). energy 시스템(max:200, cost:5/회, regen:1/분)."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "crafting_sub04"
    desc: "COOK_EXECUTE(386)→COOK_RESULT(387) 핸들러 — 요리 제작 + 음식 버프 적용(buff_duration:1800초, max_food_buff:1). grilled_meat/fish_stew/royal_feast 레시피."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "crafting_sub05"
    desc: "ENCHANT_REQ(388)→ENCHANT_RESULT(389) 핸들러 — 무기 원소 부여(fire/ice/lightning/dark/holy/nature). enchant_levels 1-3 단계. one_element_per_weapon + overwrite 규칙."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "crafting_sub06"
    desc: "제작/채집/인챈트 테스트 케이스 5개 작성 — test_tcp_bridge.py에 추가. 레시피 조회/제작 성공/재료부족 실패/채집/인챈트."
    priority: P1
    blocked: false
    estimated_minutes: 10

  # ============================================================
  # TASK 3: 경제 심화 — 거래소/일일캡/화폐 시스템 (GDD rules/economy.yaml)
  # 1:1 거래/우편은 구현됨. 거래소(경매장)는 미구현.
  # ============================================================
  - id: "economy_sub01"
    desc: "AUCTION_LIST_REQ(390)→AUCTION_LIST(391) 핸들러 — 거래소 목록 조회. category 필터 + 가격 정렬 + 페이지네이션(20개씩)."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "economy_sub02"
    desc: "AUCTION_REGISTER(392)→AUCTION_REGISTER_RESULT(393) 핸들러 — 아이템 등록. listing_fee:100골드 + max_listings:20 + listing_duration:48h. 인벤토리에서 아이템 제거."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "economy_sub03"
    desc: "AUCTION_BUY(394)→AUCTION_BUY_RESULT(395) 핸들러 — 즉시구매. tax_rate:5% 판매자 부담. 구매자 골드 차감 + 판매자 우편 정산."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "economy_sub04"
    desc: "AUCTION_BID(396)→AUCTION_BID_RESULT(397) 핸들러 — 경매 입찰. 최고가 갱신 + 이전 입찰자 환불(우편). 경매 종료 시 낙찰 처리."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "economy_sub05"
    desc: "일일 골드 캡 시스템 — daily_caps 적용 (monster:50k, dungeon:30k, quest:20k, total:100k). 서버 날짜 변경 시 리셋."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "economy_sub06"
    desc: "거래소 테스트 케이스 5개 — 등록/구매/입찰/만료/수수료 검증."
    priority: P1
    blocked: false
    estimated_minutes: 10

  # ============================================================
  # TASK 4: 퀘스트 심화 — 일일/주간 퀘스트 + 평판 (GDD rules/quests.yaml)
  # 기본 퀘스트(수락/진행/완료)는 구현됨. 반복 퀘스트/평판은 미구현.
  # ============================================================
  - id: "quest_sub01"
    desc: "DAILY_QUEST_LIST_REQ(400)→DAILY_QUEST_LIST(401) 핸들러 — 일일 퀘스트 3개 랜덤 제공 (daily_06:00 리셋). 완료 상태 추적."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "quest_sub02"
    desc: "WEEKLY_QUEST_REQ(402)→WEEKLY_QUEST(403) 핸들러 — 주간 퀘스트 1개 (wednesday_06:00 리셋). 대량 보상."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "quest_sub03"
    desc: "REPUTATION_QUERY(404)→REPUTATION_INFO(405) 핸들러 — 세력별 평판 조회. factions: village_guard, merchant_guild. tier 계산(neutral→exalted)."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "quest_sub04"
    desc: "평판 획득 로직 — 퀘스트 완료/일일퀘/몬스터 처치 시 해당 세력 평판 +N. daily_cap:500."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "quest_sub05"
    desc: "퀘스트 심화 테스트 케이스 4개 — 일일퀘 수령/완료/리셋, 평판 조회/획득."
    priority: P1
    blocked: false
    estimated_minutes: 10

  # ============================================================
  # TASK 5: 소셜 심화 — 친구/차단/파티찾기 (GDD rules/social.yaml)
  # 길드/파티/채팅은 구현됨. 친구/차단/파티찾기는 미구현.
  # ============================================================
  - id: "social_sub01"
    desc: "FRIEND_REQUEST(410)→FRIEND_REQUEST_RESULT(411) 핸들러 — 친구 요청 보내기. max_friends:100, expire:72h."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "social_sub02"
    desc: "FRIEND_ACCEPT(412)/FRIEND_REJECT(413)/FRIEND_LIST_REQ(414)→FRIEND_LIST(415) — 수락/거절/목록. 온라인 상태 + 위치 공유."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "social_sub03"
    desc: "BLOCK_PLAYER(416)/UNBLOCK(417)/BLOCK_LIST_REQ(418)→BLOCK_LIST(419) — 차단/해제/목록. 채팅 필터 + 거래 불가."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "social_sub04"
    desc: "PARTY_FINDER_LIST(420)/PARTY_FINDER_CREATE(421)/PARTY_FINDER_JOIN(422) — 파티 찾기 게시판. categories:5종, max_listings:1."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "social_sub05"
    desc: "소셜 심화 테스트 5개 — 친구 요청/수락/목록, 차단, 파티찾기."
    priority: P2
    blocked: false
    estimated_minutes: 10

  # ============================================================
  # TASK 6: 전장 시스템 (GDD rules/pvp.yaml battleground)
  # 1v1/3v3 아레나는 구현됨. 6v6 전장 + 길드전은 미구현.
  # ============================================================
  - id: "pvp_sub01"
    desc: "BATTLEGROUND_QUEUE(430)→BATTLEGROUND_STATUS(431) 핸들러 — 6v6 전장 매칭. capture_point(3거점) + payload(수레) 2모드."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "pvp_sub02"
    desc: "BATTLEGROUND_SCORE(432)→BATTLEGROUND_SCORE_UPDATE(433) — 실시간 점수 업데이트. 거점 점령(score_per_second:1, win_score:1000)."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "pvp_sub03"
    desc: "GUILD_WAR_DECLARE(434)→GUILD_WAR_STATUS(435) — 길드전 신청/수락. min_participants:10, 30분 제한, destroy_crystal 승리조건."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "pvp_sub04"
    desc: "PvP 시즌 리셋 로직 — season_duration:12주, soft_reset 공식. tier별 보상 우편 발송."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "pvp_sub05"
    desc: "전장/길드전 테스트 4개 — 전장 큐/점수/결과, 길드전 신청."
    priority: P2
    blocked: false
    estimated_minutes: 10

  # ============================================================
  # TASK 7: 칭호/도감/2차전직 (GDD rules/progression.yaml)
  # 레벨/경험치/스킬은 구현됨. 칭호/도감/전직은 미구현.
  # ============================================================
  - id: "progression_sub01"
    desc: "TITLE_LIST_REQ(440)→TITLE_LIST(441) + TITLE_EQUIP(442)→TITLE_EQUIP_RESULT(443) — 칭호 목록 + 장착(max:1). 9종 칭호 조건 체크."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "progression_sub02"
    desc: "COLLECTION_QUERY(444)→COLLECTION_INFO(445) — 도감 조회. monster_encyclopedia(4카테고리) + equipment_codex(5등급). completion_bonus 스탯."
    priority: P2
    blocked: false
    estimated_minutes: 10

  - id: "progression_sub03"
    desc: "JOB_CHANGE_REQ(446)→JOB_CHANGE_RESULT(447) — 2차 전직(레벨 20+). warrior→berserker/guardian, archer→sharpshooter/ranger, mage→archmage/priest. 스탯 보정 적용."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "progression_sub04"
    desc: "MILESTONE_CHECK 로직 — 레벨 10/15/20/30/40/50/60 도달 시 자동 보상 지급 + 시스템 해금(dungeon/pvp/raid 등)."
    priority: P1
    blocked: false
    estimated_minutes: 10

  - id: "progression_sub05"
    desc: "칭호/도감/전직 테스트 4개 — 칭호 조회/장착, 도감 등록/보너스, 전직."
    priority: P1
    blocked: false
    estimated_minutes: 10

  # ============================================================
  # 기존 유지 태스크
  # ============================================================
  - id: "entity_pipeline_review"
    desc: "C016 엔티티 파이프라인 제안 상세 검토 (Phase 2 완료됨, 이제 검토 가능)"
    priority: P2
    blocked: false

  - id: "gdd_polish"
    desc: "GDD 서버 태스크 전부 done — 추후 밸런싱/폴리싱 대기"
    priority: P3
    blocked: true
    blocked_reason: "클라이언트 구현 + 통합 테스트 후"

# ── 최근 중요 결정 ──
recent_decisions:
  - "D009: CEO 직접 지시 — 카메라는 탑다운 쿼터뷰(Lost Ark 스타일). TPS 숄더캠 X."
  - "D010: GDD 크로스파일 권위 기준 — 전문 파일이 권위 (flow.yaml=키바인딩, pvp.yaml=PvP수치 등)"
  - "스킬 8슬롯(QWERASDF) + V궁극기 + 1-4퀵슬롯 (Lost Ark 스타일)"
  - "엔티티 파이프라인 제안: 아이디어는 좋으나 현재 보류, Phase 2 후 검토"
  - "에셋 정책: SVG/코드=Git, FBX/텍스처/오디오=로컬 직접 배치"
  - "D011: GDD data/ CSV 5종 생성 — 서버/클라 에이전트가 파싱해서 사용"
  - "D012: OneDrive 동기화 문제로 _patch.py 사용 — Edit 도구 변경이 복원되는 이슈 우회"
  - "Phase 2 TCP 실연동 14/14 ALL PASS (2026-02-15) — 역사적인 첫 실연동"
  - "D013: GDD 심화 태스크 분해 — 7개 태스크 42개 서브태스크 (제작/거래소/퀘스트심화/소셜/전장/칭호)"

# ── 처리된 클라이언트 메시지 ──
processed_messages:
  - "C001"
  - "C002"
  - "C003"
  - "C004"
  - "C005"
  - "C006"
  - "C007"
  - "C008"
  - "C009"
  - "C010"
  - "C011"
  - "C012"
  - "C013"
  - "C014"
  - "C015"
  - "C016"
  - "C017"
  - "C018"
  - "C019"
  - "C020"
  - "C021"

# ── 핵심 규칙 (매 세션 리마인드) ──
rules:
  - "conversation_journal.json이 Single Source of Truth — 메시지 보내면 반드시 업데이트"
  - "GDD 변경 시 교차 일관성 확인 (D010 권위 기준 참조)"
  - "C++ 코드는 ECS 패턴 (Component=struct, System=ISystem)"
  - "클라이언트 메시지는 반드시 읽고 응답"
  - "state 파일 업데이트 필수 (컨텍스트 유실 방지)"
  - "conversation_style: 동료 개발자처럼 자연스럽게. 딱딱한 보고서 금지."
  - "대표님 결정 필요 시 _context/ask_user.yaml 사용"
  - "tcp_bridge.py 수정 시 _patch.py 사용 필수 (OneDrive 동기화 파일 복원 이슈)"

# ── 중요 참고: tcp_bridge.py 패칭 방법 ──
# OneDrive 동기화가 Edit 도구 변경을 되돌리는 문제가 있음
# Servers/BridgeServer/_patch.py를 사용하여 수정해야 함
# 실행: python _patch.py && python _patch_s034.py && python _patch_s035.py && python _patch_s036.py && python _patch_s037.py && python _patch_s040.py && python test_tcp_bridge.py
