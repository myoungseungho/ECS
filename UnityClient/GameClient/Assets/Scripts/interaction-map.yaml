# Unity Client — Manager 간 상호작용 맵
# AI 에이전트가 "이 Manager를 수정하면 어디에 영향을 주는지" 즉시 파악하기 위한 문서
# Manager 추가/수정 시 반드시 이 파일도 갱신

version: session_30_phase1_complete

# ━━━ Manager 목록 및 의존 관계 ━━━

managers:

  - name: NetworkManager
    namespace: Network
    singleton: true
    dont_destroy_on_load: true
    purpose: "Gate→Field TCP 연결 관리 + 패킷 수신/발송 + 이벤트 디스패치"
    reads:
      - TCPClient._recvQueue (메인 스레드에서 DequeueAll)
    writes:
      - ConnectionState (State 프로퍼티)
      - MyEntityId, CurrentZone, CurrentChannel
    fires_events:
      - OnLoginResult(LoginResult, uint)
      - OnCharacterList(CharacterInfo[])
      - OnEnterGame(EnterGameResult)
      - OnEntityAppear(ulong, float, float, float)
      - OnEntityDisappear(ulong)
      - OnEntityMove(ulong, float, float, float)
      - OnZoneChanged(int)
      - OnChannelChanged(int)
      - OnStatSync(StatSyncData)
      - OnAttackResult(AttackResultData)
      - OnCombatDied(CombatDiedData)
      - OnRespawnResult(RespawnResultData)
      - OnError(string)
      - OnDisconnected()
    subscribes_to: []
    public_api:
      - ConnectToGate()
      - ConnectDirect(string, int)
      - Login(string, string)
      - RequestCharList()
      - SelectCharacter(uint)
      - JoinChannel(int)
      - SendMove(float, float, float)
      - EnterZone(int)
      - RequestStatSync()
      - SendAttack(ulong)
      - RequestRespawn()
      - DisconnectAll()

  - name: GameManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: true
    purpose: "게임 상태 머신 (Login → CharSelect → InGame)"
    reads: []
    writes:
      - CurrentState (GameState enum)
    fires_events: []
    subscribes_to:
      - NetworkManager.OnLoginResult → CharSelect 전이
      - NetworkManager.OnEnterGame → InGame 전이
      - NetworkManager.OnDisconnected → Login 리셋

  - name: EntityManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "엔티티 생명주기 관리 (생성/파괴/이동)"
    reads:
      - EntityPool.Instance (오브젝트 풀 접근)
    writes:
      - _entityMap (Dictionary<ulong, GameObject>)
      - _localPlayer (GameObject)
    fires_events: []
    subscribes_to:
      - NetworkManager.OnEnterGame → 로컬 플레이어 생성
      - NetworkManager.OnEntityAppear → 리모트 플레이어 생성
      - NetworkManager.OnEntityDisappear → 리모트 플레이어 제거
      - NetworkManager.OnEntityMove → 리모트 플레이어 위치 업데이트
      - NetworkManager.OnDisconnected → 전체 엔티티 정리
    serialized_fields:
      - localPlayerPrefab: GameObject (LocalPlayer.prefab)
      - remotePlayerPrefab: GameObject (RemotePlayer.prefab)
      - usePooling: bool (default true)

  - name: EntityPool
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "RemotePlayer 오브젝트 풀링"
    reads: []
    writes:
      - _pool (Queue<GameObject>)
    fires_events: []
    subscribes_to: []
    serialized_fields:
      - prefab: GameObject (RemotePlayer.prefab)
      - preloadCount: int (default 50)

  - name: MonsterManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "몬스터 엔티티 생명주기 관리 (스폰/사망/리스폰/이동/HP 갱신/어그로)"
    reads:
      - CoordConverter (서버→Unity 좌표 변환)
    writes:
      - _monsterMap (Dictionary<ulong, MonsterEntity>)
    fires_events:
      - OnMonsterSpawned(MonsterEntity)
      - OnMonsterDied(ulong)
      - OnMonsterUpdated(MonsterEntity)
      - OnMonsterAggroChanged(ulong, ulong)
    subscribes_to:
      - NetworkManager.OnMonsterSpawn → 몬스터 생성
      - NetworkManager.OnMonsterRespawn → 몬스터 리스폰 (HP 리셋 + 재배치)
      - NetworkManager.OnCombatDied → 몬스터 사망 처리
      - NetworkManager.OnEntityMove → 몬스터 위치 업데이트
      - NetworkManager.OnAttackResult → 몬스터 HP 갱신
      - NetworkManager.OnDisconnected → 전체 몬스터 정리
      - NetworkManager.OnMonsterMove → 몬스터 이동 (서버 AI)
      - NetworkManager.OnMonsterAggro → 몬스터 어그로 변경
    public_api:
      - GetMonster(ulong) → MonsterEntity
      - IsMonster(ulong) → bool
    serialized_fields:
      - monsterPrefab: GameObject (Monster.prefab, optional)

  - name: StatsManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "내 캐릭터 스탯 동기화 및 관리"
    reads: []
    writes:
      - Level, HP, MaxHP, MP, MaxMP, ATK, DEF, EXP, EXPNext
    fires_events:
      - OnStatsChanged()
    subscribes_to:
      - NetworkManager.OnStatSync → 스탯 데이터 갱신
      - NetworkManager.OnEnterGame → 자동 STAT_QUERY 전송
    public_api: []
    computed_properties:
      - IsAlive (HP > 0)
      - HpRatio (HP / MaxHP)
      - MpRatio (MP / MaxMP)
      - ExpRatio (EXP / EXPNext)

  - name: CombatManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "전투 관리 — 공격, 사망, 부활 처리"
    reads:
      - NetworkManager.Instance.MyEntityId (사망 판정)
    writes:
      - IsDead, SelectedTarget
    fires_events:
      - OnAttackFeedback(AttackResultData)
      - OnEntityDied(CombatDiedData)
      - OnRespawnComplete(RespawnResultData)
    subscribes_to:
      - NetworkManager.OnAttackResult → 공격 결과 전달
      - NetworkManager.OnCombatDied → 사망 처리
      - NetworkManager.OnRespawnResult → 부활 처리
    public_api:
      - SelectTarget(ulong)
      - Attack(ulong)
      - Respawn()

  - name: SkillManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "스킬 시스템 관리 — 스킬 목록, 쿨다운, 사용, 레벨업"
    reads: []
    writes:
      - _skills (Dictionary<uint, SkillInfo>)
      - _cooldowns (Dictionary<uint, float>)
      - _skillPoints (uint)
    fires_events:
      - OnSkillListChanged()
      - OnSkillUsed(SkillResultData)
      - OnCooldownStarted(uint)
      - OnSkillLeveledUp(SkillLevelUpResultData)
      - OnSkillPointsChanged(uint)
    subscribes_to:
      - NetworkManager.OnSkillList → 스킬 목록 갱신
      - NetworkManager.OnSkillResult → 스킬 결과 + 쿨다운 시작
      - NetworkManager.OnEnterGame → 자동 SKILL_LIST_REQ
      - NetworkManager.OnSkillLevelUpResult → 스킬 레벨업 결과
      - NetworkManager.OnSkillPointInfo → 스킬 포인트 갱신
    public_api:
      - UseSkill(uint, ulong)
      - IsOnCooldown(uint) → bool
      - GetCooldownRemaining(uint) → float
      - GetSkill(uint) → SkillInfo
      - LevelUpSkill(uint)
    computed_properties:
      - SkillPoints (uint)

  - name: InventoryManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "인벤토리 관리 — 아이템 목록, 사용, 장착/해제"
    reads: []
    writes:
      - _items (Dictionary<byte, InventoryItemInfo>)
    fires_events:
      - OnInventoryChanged()
      - OnItemAdded(ItemAddResultData)
      - OnItemUsed(ItemUseResultData)
      - OnItemEquipped(ItemEquipResultData)
    subscribes_to:
      - NetworkManager.OnInventoryResp → 인벤토리 목록 갱신
      - NetworkManager.OnItemAddResult → 아이템 추가 결과
      - NetworkManager.OnItemUseResult → 아이템 사용 결과
      - NetworkManager.OnItemEquipResult → 아이템 장착 결과
      - NetworkManager.OnEnterGame → 자동 INVENTORY_REQ
    public_api:
      - UseItem(byte)
      - EquipItem(byte)
      - UnequipItem(byte)
      - GetItem(byte) → InventoryItemInfo

  - name: PartyManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "파티 시스템 관리 — 생성, 초대, 수락, 탈퇴, 추방"
    reads:
      - NetworkManager.Instance.MyEntityId (리더 판정)
    writes:
      - PartyId, LeaderId, Members
    fires_events:
      - OnPartyChanged()
    subscribes_to:
      - NetworkManager.OnPartyInfo → 파티 정보 갱신
    public_api:
      - CreateParty()
      - InviteToParty(ulong)
      - AcceptParty(uint)
      - LeaveParty()
      - KickMember(ulong)
    computed_properties:
      - InParty (PartyId != 0)
      - IsLeader (LeaderId == MyEntityId)

  - name: BuffManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "버프 시스템 관리 — 목록, 적용, 제거, 타이머"
    reads: []
    writes:
      - _buffs (Dictionary<uint, BuffInfo>)
    fires_events:
      - OnBuffListChanged()
      - OnBuffApplied(BuffResultData)
      - OnBuffRemoved(uint)
    subscribes_to:
      - NetworkManager.OnBuffList → 버프 목록 갱신
      - NetworkManager.OnBuffResult → 버프 적용 결과
      - NetworkManager.OnBuffRemoveResp → 버프 제거 결과
      - NetworkManager.OnEnterGame → 자동 BUFF_LIST_REQ
    public_api:
      - ApplyBuff(uint)
      - RemoveBuff(uint)
      - HasBuff(uint) → bool
      - GetBuff(uint) → BuffInfo

  - name: ChatManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "채팅 시스템 관리 — Zone/Party/Whisper/System 메시지 송수신"
    reads: []
    writes:
      - _messages (List<ChatEntry>)
    fires_events:
      - OnNewMessage(ChatEntry)
    subscribes_to:
      - NetworkManager.OnChatMessage → 채팅 메시지 수신
      - NetworkManager.OnWhisperResult → 귓속말 결과
      - NetworkManager.OnSystemMessage → 시스템 메시지
    public_api:
      - SendZoneChat(string)
      - SendPartyChat(string)
      - SendWhisper(string, string)
    computed_properties:
      - Messages (IReadOnlyList<ChatEntry>)

  - name: ShopManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "NPC 상점 관리 — 아이템 목록, 구매/판매, 골드 추적"
    reads: []
    writes:
      - _isShopOpen (bool)
      - _currentNpcId (uint)
      - _currentItems (ShopItemInfo[])
      - _gold (uint)
    fires_events:
      - OnShopOpened(ShopListData)
      - OnShopClosed()
      - OnTransactionResult(ShopResultData)
      - OnGoldChanged(uint)
    subscribes_to:
      - NetworkManager.OnShopList → 상점 아이템 목록 수신
      - NetworkManager.OnShopResult → 거래 결과
    public_api:
      - OpenShop(uint)
      - BuyItem(uint, byte)
      - SellItem(byte)
      - CloseShop()
    computed_properties:
      - IsShopOpen (bool)
      - CurrentNpcId (uint)
      - CurrentItems (ShopItemInfo[])
      - Gold (uint)

  - name: BossManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "보스 시스템 관리 — HP 추적, 페이즈 전환, 특수 공격, 인레이지"
    reads: []
    writes:
      - _bosses (Dictionary<ulong, BossState>)
    fires_events:
      - OnBossAppeared(BossState)
      - OnBossPhaseChanged(BossState)
      - OnBossSpecialAttacked(BossSpecialAttackData)
      - OnBossEnraged(BossState)
      - OnBossKilled(BossDefeatedData)
      - OnBossHPChanged(BossState)
    subscribes_to:
      - NetworkManager.OnBossSpawn → 보스 출현
      - NetworkManager.OnBossPhaseChange → 페이즈 전환
      - NetworkManager.OnBossSpecialAttack → 특수 공격
      - NetworkManager.OnBossEnrage → 인레이지
      - NetworkManager.OnBossDefeated → 보스 처치
      - NetworkManager.OnAttackResult → 보스 HP 갱신
    public_api:
      - GetBoss(ulong) → BossState
      - IsBoss(ulong) → bool

  - name: QuestManager
    namespace: (global)
    singleton: true
    dont_destroy_on_load: false
    purpose: "퀘스트 시스템 관리 — 목록, 수락, 진행, 완료"
    reads: []
    writes:
      - _quests (Dictionary<uint, QuestInfo>)
    fires_events:
      - OnQuestListChanged()
      - OnQuestAccepted(QuestAcceptResultData)
      - OnQuestCompleted(QuestCompleteResultData)
    subscribes_to:
      - NetworkManager.OnQuestList → 퀘스트 목록 갱신
      - NetworkManager.OnQuestAcceptResult → 퀘스트 수락 결과
      - NetworkManager.OnQuestCompleteResult → 퀘스트 완료 결과
      - NetworkManager.OnEnterGame → 자동 QUEST_LIST_REQ
    public_api:
      - AcceptQuest(uint)
      - CheckProgress(uint)
      - CompleteQuest(uint)
      - GetQuest(uint) → QuestInfo
      - HasQuest(uint) → bool

# ━━━ Entity 컴포넌트 ━━━

entities:

  - name: LocalPlayer
    namespace: (global)
    attached_to: LocalPlayer.prefab
    purpose: "내 캐릭터 — 입력 처리 + 카메라 추적 + 이동 전송"
    reads:
      - Input (WASD / GetAxis)
      - Camera.main
    writes:
      - transform.position, transform.rotation
      - Camera.main.transform (카메라 추적)
    calls:
      - NetworkManager.Instance.SendMove() (sendInterval 간격)
      - CoordConverter.UnityToServer()
    serialized_fields:
      - moveSpeed: float (default 5)
      - sendInterval: float (default 0.1)
      - cameraOffset: Vector3 (default 0,15,-10)
      - cameraSmoothSpeed: float (default 5)

  - name: RemotePlayer
    namespace: (global)
    attached_to: RemotePlayer.prefab
    purpose: "다른 플레이어 — 서버 위치로 보간 이동"
    reads:
      - _targetPos (SetTargetPosition으로 설정됨)
    writes:
      - transform.position, transform.rotation
    calls: []
    serialized_fields:
      - lerpSpeed: float (default 10)

  - name: MonsterEntity
    namespace: (global)
    attached_to: Monster.prefab (또는 런타임 생성 Cube)
    purpose: "몬스터 — 서버 위치로 보간 이동 + HP 추적"
    reads:
      - _targetPos (SetTargetPosition으로 설정됨)
    writes:
      - transform.position
    calls: []
    serialized_fields:
      - lerpSpeed: float (default 10)

# ━━━ 유틸리티 ━━━

utilities:

  - name: TCPClient
    namespace: Network
    purpose: "TCP 소켓 래퍼 — 백그라운드 수신 + 메인 스레드 디큐"
    threading: "수신=백그라운드 스레드, 디큐=메인 스레드(Update)"
    used_by: [NetworkManager]

  - name: PacketBuilder
    namespace: Network
    purpose: "패킷 직렬화/역직렬화 (static 유틸리티)"
    packet_format: "[4B Length LE][2B MsgType LE][Payload]"
    used_by: [NetworkManager]

  - name: CoordConverter
    namespace: (global)
    purpose: "서버↔Unity 좌표 변환"
    conversion:
      server_to_unity: "Vector3(sx * 0.1, 0, sy * 0.1)"
      unity_to_server: "(pos.x * 10, pos.z * 10)"
      server_range: "0~1000 x 0~1000 (2D)"
      unity_range: "0~100 x 0~100 (3D, y=0)"
    used_by: [EntityManager, LocalPlayer]

  - name: ConnectionTest
    namespace: (global)
    purpose: "자동화된 접속 테스트 (Gate→Login→CharSelect→InGame)"
    test_flow:
      - ConnectToGate
      - Login("hero", "pass123") after 1s
      - SelectCharacter(1) on login success
      - JoinChannel(1) on enter game
      - Spacebar → random SendMove

# ━━━ 데이터 흐름 ━━━

data_flows:

  - from: Server (TCP)
    to: TCPClient
    via: "TCP socket (background thread)"
    description: "서버 바이트 스트림 수신 → ReceivedPacket 큐에 적재"

  - from: TCPClient
    to: NetworkManager
    via: "DequeueAll() in Update()"
    description: "메인 스레드에서 패킷 디큐 → 타입별 핸들러 호출"

  - from: NetworkManager
    to: GameManager
    via: "C# events (OnLoginResult, OnEnterGame, OnDisconnected)"
    description: "게임 상태 전이 트리거"

  - from: NetworkManager
    to: EntityManager
    via: "C# events (OnEnterGame, OnEntityAppear/Disappear/Move)"
    description: "엔티티 생명주기 관리"

  - from: EntityManager
    to: EntityPool
    via: "Get()/Return() 직접 호출"
    description: "RemotePlayer 오브젝트 풀링"

  - from: NetworkManager
    to: StatsManager
    via: "C# events (OnStatSync, OnEnterGame)"
    description: "스탯 동기화 + 게임 진입 시 자동 STAT_QUERY"

  - from: NetworkManager
    to: MonsterManager
    via: "C# events (OnMonsterSpawn, OnMonsterRespawn, OnCombatDied, OnEntityMove, OnAttackResult, OnMonsterMove, OnMonsterAggro)"
    description: "몬스터 스폰/리스폰/사망/이동/HP 갱신/어그로"

  - from: MonsterManager
    to: MonsterEntity
    via: "Initialize(), SetTargetPosition() 직접 호출"
    description: "몬스터 데이터 초기화 + 위치 보간 타겟 설정"

  - from: NetworkManager
    to: CombatManager
    via: "C# events (OnAttackResult, OnCombatDied, OnRespawnResult)"
    description: "전투 결과, 사망, 부활 이벤트 전달"

  - from: StatsManager
    to: HUDManager
    via: "C# event (OnStatsChanged)"
    description: "HP/MP/EXP/Level UI 갱신"

  - from: CombatManager
    to: CombatUI
    via: "C# event (OnAttackFeedback)"
    description: "데미지 텍스트 + 타겟 HP바 갱신"

  - from: CombatManager
    to: DeathUI
    via: "C# events (OnEntityDied, OnRespawnComplete)"
    description: "사망 패널 표시/숨김"

  - from: SkillManager
    to: SkillBarUI
    via: "C# events (OnSkillListChanged, OnSkillUsed)"
    description: "스킬 목록 변경 → 슬롯 이름 갱신, 쿨다운 오버레이"

  - from: InventoryManager
    to: InventoryUI
    via: "C# event (OnInventoryChanged)"
    description: "인벤토리 변경 → 아이템 슬롯 리스트 갱신"

  - from: PartyManager
    to: PartyUI
    via: "C# event (OnPartyChanged)"
    description: "파티 상태 변경 → 멤버 리스트/버튼 갱신"

  - from: BuffManager
    to: BuffUI
    via: "C# event (OnBuffListChanged)"
    description: "버프 변경 → 아이콘 리스트 + 타이머 갱신"

  - from: QuestManager
    to: QuestUI
    via: "C# event (OnQuestListChanged)"
    description: "퀘스트 변경 → 리스트 + 진행 상황 갱신"

  - from: NetworkManager
    to: ChatManager
    via: "C# events (OnChatMessage, OnWhisperResult, OnSystemMessage)"
    description: "채팅/귓속말/시스템 메시지 수신"

  - from: ChatManager
    to: ChatUI
    via: "C# event (OnNewMessage)"
    description: "새 메시지 → 채팅 창 갱신"

  - from: NetworkManager
    to: ShopManager
    via: "C# events (OnShopList, OnShopResult)"
    description: "상점 아이템 목록/거래 결과"

  - from: ShopManager
    to: ShopUI
    via: "C# events (OnShopOpened, OnShopClosed, OnTransactionResult, OnGoldChanged)"
    description: "상점 패널 토글 + 아이템/골드 갱신"

  - from: NetworkManager
    to: BossManager
    via: "C# events (OnBossSpawn, OnBossPhaseChange, OnBossSpecialAttack, OnBossEnrage, OnBossDefeated, OnAttackResult)"
    description: "보스 출현/페이즈/특수공격/인레이지/처치/HP 갱신"

  - from: BossManager
    to: BossUI
    via: "C# events (OnBossAppeared, OnBossPhaseChanged, OnBossSpecialAttacked, OnBossEnraged, OnBossKilled, OnBossHPChanged)"
    description: "보스 HP바, 페이즈 표시, 알림 팝업"

  - from: LocalPlayer
    to: NetworkManager
    via: "SendMove() 직접 호출"
    description: "WASD 입력 → 서버 이동 패킷 전송 (0.1초 간격)"

  - from: EntityManager
    to: RemotePlayer
    via: "SetTargetPosition() 직접 호출"
    description: "서버 위치 → 보간 타겟 설정"

# ━━━ 좌표 변환 파이프라인 ━━━

coordinate_pipeline:
  description: "서버(2D 0~1000) ↔ Unity(3D 0~100) 변환"
  steps:
    - name: "서버 → Unity (수신)"
      trigger: "OnEntityAppear, OnEntityMove, OnEnterGame"
      function: "CoordConverter.ServerToUnity(sx, sy)"
      mapping: "x=sx*0.1, y=0, z=sy*0.1"
    - name: "Unity → 서버 (송신)"
      trigger: "LocalPlayer.HandleMovement()"
      function: "CoordConverter.UnityToServer(pos)"
      mapping: "sx=pos.x*10, sy=pos.z*10"
  warning: "서버 Y축 → Unity Z축 매핑에 주의"
