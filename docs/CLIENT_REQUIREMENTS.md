# 클라이언트 구현 요구사항

> **작성일**: 2026-02-11
> **대상**: 클라이언트 개발팀
> **참조**: `SERVER_IMPLEMENTATION_SUMMARY.md` (서버 구현 현황)

서버는 29개 세션 (321개 테스트) 전부 통과 상태입니다.
아래는 각 시스템별로 **클라이언트에서 구현해야 할 항목**입니다.

---

## 0. 공통 사항

### 패킷 송수신 기본

```
모든 패킷: [length(4, LE)] [msg_type(2, LE)] [payload(N)]
헤더 크기: 6바이트
바이트 순서: Little-Endian 전체 통일
최대 패킷: 8192바이트
```

**클라이언트 필수 구현:**
- TCP 스트림에서 패킷 조립기 (length 읽고 → 나머지 바이트 수신)
- 분할 수신 처리 (한 번의 recv로 패킷이 다 안 올 수 있음)
- 메시지 타입별 디스패처 (switch/map으로 핸들러 분기)

### 접속 흐름

```
1. GateServer(8888)에 접속
2. GATE_ROUTE_REQ(70) 전송 → GATE_ROUTE_RESP(71) 수신 (FieldServer IP:Port 받음)
3. GateServer 연결 끊기
4. FieldServer(받은 포트)에 접속
5. LOGIN(60) → LOGIN_RESULT(61)
6. CHAR_LIST_REQ(62) → CHAR_LIST_RESP(63)
7. CHAR_SELECT(64) → ENTER_GAME(65)
8. 게임 시작!
```

> **테스트 편의**: GateServer 없이 FieldServer(7777) 직접 접속도 가능 (5번부터 시작)

---

## 1. 네트워크 레이어

### 필수 구현

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| **패킷 조립기** | TCP 스트림 → 완성된 패킷 추출 | P0 |
| **메시지 디스패처** | msg_type별 핸들러 호출 | P0 |
| **연결 관리** | 접속/끊김/재접속 상태 머신 | P0 |
| **하트비트** | 서버가 끊김 감지할 수 있게 주기적 PING(2) 전송 (30초 권장) | P1 |

---

## 2. 로그인/캐릭터 선택 UI

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **로그인 화면** | LOGIN(60) 전송 | ID/PW 입력 → 서버 전송 |
| **로그인 결과 처리** | LOGIN_RESULT(61) 수신 | result 코드별 에러 메시지 표시 |
| **캐릭터 선택 화면** | CHAR_LIST_RESP(63) 수신 | 캐릭터 목록 UI (이름, 레벨, 직업) |
| **캐릭터 선택** | CHAR_SELECT(64) 전송 | 선택한 char_id 전송 |
| **게임 진입** | ENTER_GAME(65) 수신 | entity_id, zone, 좌표 받아 씬 로딩 |

**에러 코드 표시:**
| result | 메시지 (예시) |
|--------|---------------|
| 0 | (성공, 다음 단계로) |
| 1 | "존재하지 않는 계정입니다" |
| 2 | "비밀번호가 틀렸습니다" |
| 3 | "이미 접속 중인 계정입니다" |

---

## 3. 이동 시스템

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **이동 요청** | MOVE(10) 전송 | 클릭/키보드 → `x, y, z` 좌표 전송 |
| **타인 이동** | MOVE_BROADCAST(11) 수신 | 다른 플레이어 위치 업데이트 |
| **Entity 출현** | APPEAR(13) 수신 | 시야에 들어온 Entity 생성 (캐릭터 모델 로딩) |
| **Entity 사라짐** | DISAPPEAR(14) 수신 | 시야에서 나간 Entity 제거 |

**핵심 주의사항:**
- AOI 그리드: 500 유닛 기준. 500 유닛 이내 Entity만 APPEAR/BROADCAST 수신
- 이동 시 자기 자신의 MOVE_BROADCAST는 수신 안 됨 (서버가 필터링)
- APPEAR 수신 시 해당 Entity의 현재 위치 정보 포함됨 → 즉시 해당 위치에 표시

---

## 4. 존(맵) 시스템

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **존 전환 요청** | ZONE_TRANSFER_REQ(120) 전송 | 포탈/NPC 상호작용 시 |
| **존 전환 결과** | ZONE_TRANSFER_RESULT(121) 수신 | 성공 시 새 맵 로딩 + 좌표 이동 |
| **채널 변경** | CHANNEL_JOIN(20) 전송 | 채널 선택 UI |

**존 전환 시 클라이언트 처리:**
1. 요청 전송 → 로딩 화면 표시
2. 결과 수신 → result==0이면 새 zone_id 맵 로딩
3. 기존 Entity 전부 제거 (새 맵에서 APPEAR로 다시 받음)
4. 수신된 좌표로 카메라/캐릭터 이동

---

## 5. 스탯/전투 시스템

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **스탯 표시** | STAT_SYNC(91) 수신 | HP/MP 바, 레벨, ATK/DEF 표시 |
| **공격 요청** | ATTACK_REQ(100) 전송 | 타겟 클릭 → target_entity 전송 |
| **공격 결과** | ATTACK_RESULT(101) 수신 | 데미지 숫자 표시, HP바 업데이트 |
| **사망 처리** | COMBAT_DIED(102) 수신 | 사망 연출 + 부활 UI |
| **부활 요청** | RESPAWN_REQ(103) 전송 | 부활 버튼 클릭 |
| **부활 결과** | RESPAWN_RESULT(104) 수신 | HP/MP 회복, 좌표 이동 |

**ATTACK_RESULT 파싱 (29바이트):**
```
오프셋  필드             크기   설명
0       result           1      AttackResult 코드
1       attacker         8      공격자 entity
9       target           8      피격자 entity
17      damage           4      데미지 (i32)
21      target_hp        4      타겟 남은 HP
25      target_max_hp    4      타겟 최대 HP
```

**필요한 UI/연출:**
- 데미지 숫자 팝업 (내 공격, 받은 공격 색상 분리)
- HP바 실시간 업데이트
- 사망 시 화면 효과 + "부활" 버튼
- 공격 쿨타임 표시 (2초)
- 사거리 밖이면 "사거리 초과" 메시지

### 몬스터 관련

| 항목 | 패킷 | 설명 |
|------|------|------|
| **몬스터 스폰** | MONSTER_SPAWN(110) 수신 | 몬스터 모델 생성 + HP바 |
| **몬스터 리스폰** | MONSTER_RESPAWN(113) 수신 | 같은 위치에 HP 풀 상태로 재생성 |

---

## 6. 스킬 시스템

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **스킬 목록** | SKILL_LIST_RESP(151) 수신 | 스킬 슬롯 UI 표시 |
| **스킬 사용** | SKILL_USE(152) 전송 | 스킬 슬롯 클릭 + 타겟 선택 |
| **스킬 결과** | SKILL_RESULT(153) 수신 | 이펙트 재생 + 데미지 표시 |

**필요한 UI:**
- 스킬 슬롯 바 (단축키 1~4 등)
- 스킬별 쿨타임 표시 (회전 딤 효과)
- MP 부족 시 슬롯 비활성화
- 스킬 이펙트 (근접/원거리/회복별 다른 연출)

---

## 7. 파티 시스템

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **파티 생성** | PARTY_CREATE(160) 전송 | 파티 생성 버튼 |
| **파티 초대** | PARTY_INVITE(161) 전송 | 대상 우클릭 → "초대" |
| **초대 수락** | PARTY_ACCEPT(162) 전송 | 초대 팝업 → "수락" |
| **파티 탈퇴** | PARTY_LEAVE(163) 전송 | 파티 UI → "탈퇴" |
| **파티 추방** | PARTY_KICK(165) 전송 | 파티장만 가능 |
| **파티 정보** | PARTY_INFO(164) 수신 | 파티원 HP바 + 레벨 표시 |

**필요한 UI:**
- 파티원 프레임 (화면 좌측, HP/MP바 + 이름 + 레벨)
- 초대 알림 팝업 (수락/거절)
- 파티장 표시 (왕관 아이콘 등)

---

## 8. 인스턴스 던전 + 매칭

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **던전 생성** | INSTANCE_CREATE(170) 전송 | 던전 NPC 대화 → "입장" |
| **던전 입장 결과** | INSTANCE_ENTER(171) 수신 | 던전 맵 로딩 |
| **던전 퇴장** | INSTANCE_LEAVE(172) 전송 | "나가기" 버튼 |
| **매칭 등록** | MATCH_ENQUEUE(180) 전송 | 매칭 UI → "등록" |
| **매칭 취소** | MATCH_DEQUEUE(181) 전송 | "취소" 버튼 |
| **매칭 성사** | MATCH_FOUND(182) 수신 | "매칭 완료!" 팝업 → 수락/거절 |
| **매칭 수락** | MATCH_ACCEPT(183) 전송 | "수락" 버튼 |
| **매칭 상태** | MATCH_STATUS(184) 수신 | 대기 순위 표시 |

**필요한 UI:**
- 던전 목록 화면 (NPC 대화창)
- 매칭 대기 UI (눈 아이콘 + 대기 시간/순위)
- 매칭 성사 팝업 (수락 버튼 + 카운트다운)

---

## 9. 인벤토리/아이템

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **인벤토리 요청** | INVENTORY_REQ(190) 전송 | 인벤토리 창 열 때 |
| **인벤토리 표시** | INVENTORY_RESP(191) 수신 | 슬롯별 아이템 + 수량 표시 |
| **아이템 사용** | ITEM_USE(194) 전송 | 아이템 더블클릭 |
| **아이템 장착** | ITEM_EQUIP(196) 전송 | 장비 우클릭 |
| **아이템 해제** | ITEM_UNEQUIP(197) 전송 | 장착된 아이템 클릭 |

**INVENTORY_RESP 파싱:**
```
[0]     count (u8)        총 아이템 수
엔트리당 8바이트:
  [0]   slot (u8)         슬롯 번호
  [1:5] item_id (u32)     아이템 ID
  [5:7] count (u16)       수량
  [7]   equipped (u8)     장착 여부 (0/1)
```

**필요한 UI:**
- 인벤토리 그리드 (20슬롯, 서버 MAX_INVENTORY_SLOTS=20)
- 아이템 아이콘 + 수량 배지
- 장착 상태 표시 (테두리 하이라이트)
- 사용/장착/해제 컨텍스트 메뉴

---

## 10. 버프/디버프

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **버프 목록** | BUFF_LIST_RESP(201) 수신 | 활성 버프 아이콘 표시 |
| **버프 적용** | BUFF_RESULT(203) 수신 | 버프 아이콘 추가 + 스택 표시 |
| **버프 제거** | BUFF_REMOVE_RESP(205) 수신 | 버프 아이콘 제거 |

**필요한 UI:**
- 버프 아이콘 바 (캐릭터 이름 아래 또는 HP바 옆)
- 남은 시간 표시 (초 또는 프로그레스)
- 스택 수 표시 (아이콘 우하단 숫자)
- 버프(긍정) / 디버프(부정) 색상 분리

---

## 11. 퀘스트 시스템

### 구현 항목

| 항목 | 패킷 | 설명 |
|------|------|------|
| **퀘스트 목록** | QUEST_LIST_RESP(231) 수신 | 퀘스트 로그 UI |
| **퀘스트 수락** | QUEST_ACCEPT(232) 전송 | NPC 대화 → "수락" |
| **수락 결과** | QUEST_ACCEPT_RESULT(233) 수신 | 성공/실패 메시지 |
| **퀘스트 완료** | QUEST_COMPLETE(235) 전송 | NPC 대화 → "완료" |
| **완료 결과** | QUEST_COMPLETE_RESULT(236) 수신 | 보상 획득 연출 |

**QUEST_LIST_RESP 파싱:**
```
[0]     count (u8)        퀘스트 수
엔트리당 13바이트:
  [0:4]  quest_id (u32)   퀘스트 ID
  [4]    state (u8)       상태 (1=수락, 2=진행중, 3=완료가능, 4=보상받음)
  [5:9]  progress (u32)   현재 진행도
  [9:13] target (u32)     목표치
```

**QUEST_COMPLETE_RESULT 파싱:**
```
[0]     result (u8)           결과 코드
[1:5]   quest_id (u32)        퀘스트 ID
[5:9]   reward_exp (u32)      보상 경험치
[9:13]  reward_item_id (u32)  보상 아이템 ID
[13:15] reward_item_count (u16) 보상 아이템 수량
```

**필요한 UI:**
- 퀘스트 로그 (진행중/완료 탭)
- 진행도 바 (예: "고블린 처치 2/3")
- NPC 머리 위 퀘스트 마크 (! = 수락가능, ? = 완료가능)
- 보상 획득 팝업 (아이템 아이콘 + EXP 숫자)
- 퀘스트 추적 HUD (화면 우측, 현재 진행중인 퀘스트 요약)

**퀘스트 상태 흐름:**
```
NPC 대화 → QUEST_ACCEPT → [수락됨]
                              ↓
                      몬스터 킬 (서버가 자동 추적)
                              ↓
                         [완료 가능] ← progress >= target
                              ↓
                NPC 대화 → QUEST_COMPLETE → [보상 지급]
```

---

## 12. 공간 쿼리 (선택적)

> 클라이언트에서 직접 사용할 일은 적지만, 디버그/GM 도구에 활용 가능

| 항목 | 패킷 | 설명 |
|------|------|------|
| 범위 검색 | SPATIAL_QUERY_REQ(215) 전송 | 주변 Entity 검색 |
| 결과 수신 | SPATIAL_QUERY_RESP(216) 수신 | 거리순 Entity 목록 |

---

## 13. 조건 엔진 (서버 내부용)

> 클라이언트가 직접 호출할 필요는 없음. 서버가 내부적으로 사용.
> 다만 NPC 대화/퀘스트 조건 표시에 서버 결과를 활용할 수 있음.

**활용 예시:**
- 퀘스트 수락 조건 안 맞을 때 → 서버가 에러 코드 반환 → 클라에서 "레벨 50 이상 필요" 표시
- 특정 스킬 사용 조건 → 서버가 체크 후 결과 반환

---

## 14. 루트/드롭 (서버 처리)

> 몬스터 사망 시 드롭은 서버가 자동 처리. 클라이언트는 아이템 획득 결과만 수신.

**현재 흐름:**
1. 몬스터 사망 → 서버가 LOOT_ROLL → 인벤토리에 자동 추가
2. 클라이언트는 ITEM_ADD_RESULT(193) 또는 인벤토리 갱신으로 확인

**향후 확장 가능:**
- 드롭 아이템을 바닥에 표시 → 클릭해서 줍기 방식
- 이 경우 새 패킷 추가 필요 (LOOT_DROP, LOOT_PICKUP 등)

---

## 15. 구현 우선순위 가이드

### P0 - 반드시 필요 (게임 플레이 불가능)

1. 패킷 송수신 + 조립기
2. 로그인 + 캐릭터 선택
3. 이동 + 카메라
4. 타 Entity 표시 (APPEAR/DISAPPEAR/MOVE_BROADCAST)
5. HP/MP 바 (STAT_SYNC)
6. 기본 공격 (ATTACK_REQ → ATTACK_RESULT)
7. 사망/부활

### P1 - 핵심 콘텐츠

8. 인벤토리 UI
9. 스킬 슬롯 + 사용
10. 퀘스트 UI + 진행도
11. 몬스터 표시/HP바
12. 존 전환

### P2 - 소셜/그룹

13. 파티 시스템 UI
14. 인스턴스 던전 + 매칭
15. 버프/디버프 표시
16. 채널 선택

### P3 - 편의/추가

17. 장비 장착 UI
18. 하트비트
19. 재접속 처리
20. GM 도구 (공간 쿼리 등)

---

## 16. 자주 묻는 질문

### Q: 서버 테스트는 어떻게 돌리나요?
```bash
cd GameServerSkeleton
python build.py              # 빌드
python test_session1.py      # 개별 세션
python test_all_sessions.py  # 전체 29개 세션
```

### Q: 서버에 새 패킷을 추가하고 싶으면?
1. `Components/PacketComponents.h`의 `MsgType` enum에 ID 추가
2. `Servers/FieldServer/main.cpp`에 핸들러 함수 작성
3. `dispatch.RegisterHandler()`로 등록

### Q: 좌표계가 어떻게 되나요?
- float 3D: (x, y, z), z는 현재 항상 0 (2D 평면)
- AOI 그리드: 500 유닛 단위
- 공격 사거리: 200 유닛

### Q: 몬스터가 먼저 공격하나요?
- 네. 플레이어가 몬스터 어그로 범위(250 유닛)에 들어가면 자동 공격
- 클라이언트는 ATTACK_RESULT(101)을 수신해서 피격 처리 필요
- 몬스터 공격 쿨타임: 2초

### Q: STAT_SYNC는 언제 오나요?
- 레벨업, 데미지, 힐, 버프 적용/해제 등 스탯이 변경될 때마다
- 공격 받을 때도 수신됨 (HP 변경)
- 접속 직후에도 초기 스탯으로 수신

### Q: 바이트 순서는?
- **전부 Little-Endian**. 예외 없음.
- uint16, uint32, uint64, int32, float 모두 LE.

---

## 17. 연락처

서버 관련 질문은 서버팀으로 문의해주세요.
패킷 명세 변경이 필요한 경우 반드시 양쪽 합의 후 진행합니다.
